# openEHR-skeleton

Step by step example of how eHealth apps are created in compliance with the openEHR standard

This sample app was designed and coded by Pablo Pazos pablo.pazos@cabolabs.com / https://github.com/ppazos from CaboLabs: experts in Health Informatics, Standards and Interoperability.

This code can be used only for educational purposes. &copy; CaboLabs 2016


## Use of Grails 2.5.3 as the base development framework

https://grails.org/download.html

Download and install it. Follow the instruction on the Grails website.


## Create your new application

: grails create-app openEHR-skeleton

Grails will generate the basic structure for the project.


## Create a default controller

: cd openEHR-skeleton
: grails create-controller com.cabolabs.openehr.skeleton.Records

This will generate the empty controller and the empty test of the controller.
Also it will create a folder with the controller name under the /views folder:

| Created file grails-app/controllers/com/cabolabs/openehr/skeleton/RecordsController.groovy
| Created file grails-app/views/records
| Created file test/unit/com/cabolabs/openehr/skeleton/RecordsControllerSpec.groovy

The controller will receive requests from users and retrieve views and data.


## Adding views for recording clinical data

We can add our custom views with forms to allow users to record clinical data, but we will do this in a better and smarter way: let's auto-generate the forms and integrate those forms into this app.

Clone or download the ZIP of the openEHR-ADL project: https://github.com/ppazos/openEHR-ADL

1. Execute these commands in order to compile, package and test the project: build, jargen, test
2. If everything is working OK, use the uigen command to generate some HTML files, usage example:

: uigen openEHR-EHR-OBSERVATION.blood_pressure.v1 archetype en

The uigen will generate an HTML file in the /html folder of the openEHR-ADL project. Try to open it in your web browser. All the labels and fields where generated from information contained in the blood pressure openEHR archetype.

Under openEHR-ADL/resources/archetypes/entry/observation you will find more archetypes to test the form generator. Generate a couple more.

Rename those files using the concept part of the archetype ID: for the HTML generated by the openEHR-EHR-OBSERVATION.blood_pressure.v1 archetype, rename the HTML to create_blood_pressure.gsp (yes, use the gsp extension).

Copy all those .gsp files into the projects view folder, under the controller folder: grails-app/views/records

You should have:

```
openEHR-skeleton
|_ grails-app
   |_ views
      |_ records
         |_ create_blood_pressure.gsp
         |_ ...
```
         
## Integrate the view with the controller

Open the controller grails-app/controllers/com/cabolabs/openehr/skeleton/RecordsController.groovy in a text editor, and add a method called create_blood_pressure, like this:

```
package com.cabolabs.openehr.skeleton

class RecordsController {

    def index()
    {
    }
    
    def create_blood_pressure()
    {
    }
}
```

Save the controller.


## Let's run the application to see what we have done.

Execute this command from the openEHR-skeleton project folder in the console:

: grails run-app


Grails will indicate that the app is running on: http://localhost:8080/openEHR-skeleton

Try accessing: http://localhost:8080/openEHR-skeleton/records/create_blood_pressure

The app should display the form, needs some style adjustments, but the structure is there!


## Now we want the data entered in the form to reach the controller

Open the grails-app/views/record/create_blood_pressure.gsp file in a text editor.

Add a g:form tag to contain the form. That is a Grails form. Also, we will add a submit button at the end of the form.

The view should look like this:

```
<html>
  <head>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="container">
      <h1>openEHR-EHR-OBSERVATION.blood_pressure.v1</h1>
      <g:form action="save_blood_pressure">
        <input type="hidden" name="archetypeId" value="openEHR-EHR-OBSERVATION.blood_pressure.v1" />
        <div class="OBSERVATION">
        ...
        </div>
        <input type="submit" name="save" value="Submit" />
      </g:form>
    </div>
  </body>
</html>
```


## And we need to add an action in the controller to receive the the data from the form

It should have the same name as the action value on the g:form in the view. Right now we are not doing anything with the data, just showing it in the console. In a controller action, "params" is a map containing the names and values of the data submitted from a form by an user, then it will redirect to the create_blood_pressure action and you will see the empty form again.

```
package com.cabolabs.openehr.skeleton

class RecordsController {

    def index()
    {
    }
    
    def create_blood_pressure()
    {
    }
    
    def save_blood_pressure()
    {
       println params
       redirect action: 'create_blood_pressure'
    }
}
```

Now:

1. Go to: http://localhost:8080/openEHR-skeleton/records/create_blood_pressure
2. Fill some data and submit
3. Check the console, it should show the data you just submitted. It will be difficult to read, but the data should be there:

```
[
 archetypeId:openEHR-EHR-OBSERVATION.blood_pressure.v1,
 /data[at0001]/events[at0006]/state[at0007]/items[at1005]/value/magnitude:, 
 /data[at0001]/events[at1042]/data[at0003]/items[at1007]/value/magnitude:,
 save:Submit, 
 /protocol[at0011]/items[at0013]/value/defining_code:at0015,  
 /data[at0001]/events[at1042]/data[at0003]/items[at1007]/value/units:mm[Hg],
 /data[at0001]/events[at1042]/data[at0003]/items[at0004]/value/units:mm[Hg],  /data[at0001]/events[at0006]/state[at0007]/items[at1043]
 /value/defining_code:at1044, 
 /protocol[at0011]/items[at1038]/value:, 
 /data[at0001]/events[at1042]/data[at0003]/items[at0033]/value:, 
 /data[at0001]/events[at1042]/data[at0003]/items[at0004]/value/magnitude:, 
 /data[at0001]/events[at0006]/data[at0003]/items[at1007]/value/units:mm[Hg], 
 /data[at0001]/events[at1042]/data[at0003]/items[at0005]/value/magnitude:,  
 /data[at0001]/events[at0006]/state[at0007]/items[at1005]/value/units:∩┐╜, 
 /data[at0001]/events[at0006]/state[at0007]/items[at0008]/value/defining_code:at1000,  
 /data[at0001]/events[at0006]/state[at0007]/items[at1052]/value:,
 /data[at0001]/events[at1042]/state/items[at0008]/value/defining_code:at1000, /data[at0001]/events[at0006]/data[at0003]/items[at0005]/value/magnitude:90, /data[at0001]/events[at1042]/data[at0003]/items[at1006]/value/units:mm[Hg], 
 /protocol[at0011]/items[at1033]/items[at1034]/value:,
 /data[at0001]/events[at1042]/data[at0003]/items[at0005]/value/units:mm[Hg], /protocol[at0011]/items[at1010]/value/defining_code:at1011, /data[at0001]/events[at0006]/data[at0003]/items[at1007]/value/magnitude:, /protocol[at0011]/items[at1035]/value/defining_code:at1036, 
 /data[at0001]/events[at0006]/data[at0003]/items[at0004]/value/units:mm[Hg], /data[at0001]/events[at0006]/data[at0003]/items[at1006]/value/magnitude:, /data[at0001]/events[at0006]/data[at0003]/items[at1006]/value/units:mm[Hg], /data[at0001]/events[at1042]/state/items[at1043]/value/defining_code:at1044,
 /data[at0001]/events[at1042]/state[at0007]/items[at1052]/value:, 
 /data[at0001]/events[at0006]/data[at0003]/items[at0004]/value/magnitude:120, /data[at0001]/events[at0006]/data[at0003]/items[at0005]/value/units:mm[Hg], /data[at0001]/events[at0006]/data[at0003]/items[at0033]/value:, 
 /data[at0001]/events[at1042]/state[at0007]/items[at1005]/value/units:∩┐╜, /data[at0001]/events[at1042]/math_function/defining_code:146, /data[at0001]/events[at1042]/data[at0003]/items[at1006]/value/magnitude:, /data[at0001]/events[at1042]/state[at0007]/items[at1005]/value/magnitude:, /protocol[at0011]/items[at1033]/items[at0014]/value/defining_code:at0025, 
 action:save_blood_pressure, 
 format:null, 
 controller:records]
```

Well done!


## Let's add some style before continuing

We'll use Twitter Bootstrap (http://getbootstrap.com/). Since Grails already has a plugin to include Boostrap into a Grails project, we will use that plugin: https://grails.org/plugin/twitter-bootstrap

As the doc says, just open: grails-app/conf/BuildConfig.groovy in a text editor, and add the dependency to the plugin on the plugins section. It should look like this:

```
plugins {
  ...
  runtime ':twitter-bootstrap:3.3.5'
  ...
}
```

Run the app again, it will download the new plugin dependency.

: grails run-app


Follow their documentation to add the Bootstrap JS and CSS: https://github.com/groovydev/twitter-bootstrap-grails-plugin/blob/master/README.md

We updated these files:
 + grails-app/assets/stylesheets/application.css
 + grails-app/assets/stylesheets/application.js

And added:
 + grails-app/assets/stylesheets/style.css

And added the layout meta tag to our create_blood_pressure.gsp view:

```
<html>
  <head>
    <meta name="layout" content="main"/>
  </head>
  <body>
    <div class="container">
      <h1>openEHR-EHR-OBSERVATION.blood_pressure.v1</h1>
      ...
```

Now reload the app and the form should look a lot better. Some input fields might be larger than required, we can fix that later. Let's continue with the important stuff. Check all the changes here: https://github.com/ppazos/openEHR-skeleton/commit/37b1c7f6152f45d5c6fa8a15b81e11580e88fe6a


## Add data validation to your controller

openEHR archetypes and templates enable the formal definition of the EHR information structure and constraints. We can use those definitions for data input validation. Right now, our controller is receiving data from the view, and we need to use the correspondent archetypes or templates to validate that data. Lets use archetypes to validate the data.


### Include dependencies

First, include openEHR binary dependencies under the openEHR-skeleton/lib folder. Get all the JARs from here: https://github.com/ppazos/openEHR-skeleton/tree/master/lib


Then add some archetypes to the project. Lets create an archetypes folder inside the project, and copy the archetypes from the openEHR-ADL project: https://github.com/ppazos/openEHR-ADL/tree/master/resources/archetypes, the result is: https://github.com/ppazos/openEHR-skeleton/tree/master/archetypes


### Using archetypes in the controller

Open the RecordsController.groovy in a text editor, and add the code to load the archetypes and get the correspondent archetype, used to generate the view, in the save_blood_pressure() action:

```
package com.cabolabs.openehr.skeleton

import com.cabolabs.openehr.adl.ArchetypeManager

class RecordsController {

    private static String PS = File.separator
    private static String path = "."+ PS +"archetypes"

    def index()
    {
    }
    
    def create_blood_pressure()
    {
    }
    
    def save_blood_pressure()
    {
       println params
       
       def loader = ArchetypeManager.getInstance(path)
       loader.loadAll()
       
       def archetype = loader.getArchetype(params.archetypeId)
       
       assert archetype.archetypeId.value == params.archetypeId
       
       redirect action: 'create_blood_pressure'
    }
}
```


### And now we process all the parameters and try to validate the data values

TBD

